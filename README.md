# AWS-lambda-check-datasource serverless API

## Description

This is a simple AWS Lambda function that checks connectivity to a MySQL datasource and returns all users if the datasource is available.

<b>Software architecture:</b> Package-by-feature software architecture with MVC design pattern

## Requirements

- Jave 21 or greater (OpenJDK Corretto)
- Maven 3.9.x or greater
- Valid account in AWS Cloud

## Features

Connects to a MySQL instance using environment variables:

`DB_URL`, `DB_USER`, `DB_PASSWORD`

Returns all users when the database is UP.

Integrated with AWS EventBridge.

Triggered daily with AWS EventBridge cron(0 10 * * ? *) for automated datasource checks.

## Test Details

Template: `API Gateway AWS Proxy`

Method: `GET`

Endpoint: `/users`

## Setup

Create the project:

1. Create via dedicated IDE and Maven archetype: `com.amazonaws.serverless.archetypes:aws-serverless-springboot3-archetype`

2. Create via bash command:
```bash
mvn archetype:generate -DgroupId=my.service -DartifactId=my-service -Dversion=1.0-SNAPSHOT \
       -DarchetypeGroupId=com.amazonaws.serverless.archetypes \
       -DarchetypeArtifactId=aws-serverless-springboot3-archetype \
       -DarchetypeVersion=2.0.1
```

Deploy the Lambda function with runtime

Set the following environment variables in Lambda configuration:

`DB_URL` – MySQL connection string

`DB_USER` – database username

`DB_PASSWORD` – database password

Configure EventBridge rule with schedule expression:

```text
cron(0 10 * * ? *)
```

## Autogenerated text from Maven archetype

The AWS-lambda-check-datasource project, created with [`aws-serverless-java-container`](https://github.com/aws/serverless-java-container).

The starter project defines a simple `/users` resource that can accept `GET` requests with its tests.

The project folder also includes a `template.yml` file. You can use this [SAM](https://github.com/awslabs/serverless-application-model) file to deploy the project to AWS Lambda and Amazon API Gateway or test in local with the [SAM CLI](https://github.com/awslabs/aws-sam-cli). 

## Pre-requisites
* [AWS CLI](https://aws.amazon.com/cli/)
* [SAM CLI](https://github.com/awslabs/aws-sam-cli)
* [Gradle](https://gradle.org/) or [Maven](https://maven.apache.org/)

## Building the project
You can use the SAM CLI to quickly build the project
```bash
$ mvn archetype:generate -DartifactId=AWS-lambda-check-datasource -DarchetypeGroupId=com.amazonaws.serverless.archetypes -DarchetypeArtifactId=aws-serverless-jersey-archetype -DarchetypeVersion=2.1.4 -DgroupId=org.example -Dversion=1.0-SNAPSHOT -Dinteractive=false
$ cd AWS-lambda-check-datasource
$ sam build
Building resource 'AwsLambdaCheckDatasourceFunction'
Running JavaGradleWorkflow:GradleBuild
Running JavaGradleWorkflow:CopyArtifacts

Build Succeeded

Built Artifacts  : .aws-sam/build
Built Template   : .aws-sam/build/template.yaml

Commands you can use next
=========================
[*] Invoke Function: sam local invoke
[*] Deploy: sam deploy --guided
```

## Testing locally with the SAM CLI

From the project root folder - where the `template.yml` file is located - start the API with the SAM CLI.

```bash
$ sam local start-api

...
Mounting com.amazonaws.serverless.archetypes.StreamLambdaHandler::handleRequest (java11) at http://127.0.0.1:3000/{proxy+} [OPTIONS GET HEAD POST PUT DELETE PATCH]
...
```

Using a new shell, you can send a test ping request to your API:

```bash
$ curl -s http://127.0.0.1:3000/users | python -m json.tool
``` 

## Deploying to AWS
To deploy the application in your AWS account, you can use the SAM CLI's guided deployment process and follow the instructions on the screen

```
$ sam deploy --guided
```

Once the deployment is completed, the SAM CLI will print out the stack's outputs, including the new application URL. You can use `curl` or a web browser to make a call to the URL

```
...
-------------------------------------------------------------------------------------------------------------
OutputKey-Description                        OutputValue
-------------------------------------------------------------------------------------------------------------
AwsLambdaCheckDatasourceApi - URL for application            https://xxxxxxxxxx.execute-api.us-west-2.amazonaws.com/Prod/users
-------------------------------------------------------------------------------------------------------------
```

Copy the `OutputValue` into a browser or use curl to test your first request:

```bash
$ curl -s https://xxxxxxx.execute-api.us-west-2.amazonaws.com/Prod/users | python -m json.tool
```
